<html>
<head>
    <title>Facebook & LinkedIn Page Post Permission</title>
    <script src="https://connect.facebook.net/en_US/sdk.js"></script>
</head>
<body>
    <h1>Immersive Social Network Access</h1>

    <p>
        Test access for: 
        <select id="account" onchange="switchAccount()">
            <option value="">(select account)</option>
            <option value="bb28f8a9-a43e-433b-b966-657ba998921e">paul@immersivei.com'</option>
            <option value="6a3aedc4-46d1-4c88-af20-55b437193941">trey@immersivei.com</option>
        </select>
    </p>

    <h2>Login with Facebook to Manage Page Posts</h2>
    <button onclick="loginWithFacebook()">Login with Facebook</button>

    <h2>Login with LinkedIn to Get Access Token</h2>
    <button onclick="loginWithLinkedIn()">Login with LinkedIn</button>

    <p id="message">

    </p>


    <script>
        const immersiveClientId = getImmersiveClientId(); 
        const linkedInCode = getLinkedInCode();
        const facebookAppId = '1259638752405192';
        const linkedInClientId = '86d3s5866lb98l';
        // const immersiveiApiHost =  'https://localhost:51179/'
        const immersiveiApiHost =  'https://immersivei-test.azurewebsites.net/';


        // Facebook SDK
        window.fbAsyncInit = function () {
             FB.init({
                appId: facebookAppId, // Replace with your Facebook App ID
                cookie: true,
                xfbml: true,
                version: 'v23.0'
            });
        };

        function showMessage(message) {
            console.log(message)
            document.getElementById('message').textContent = message;
        }

        function switchAccount() {
            const option = document.getElementById("account");
            const client = option.value;
            window.location = window.location.search = `?client=${client}`;
        }

        function loginWithFacebook() {
            FB.login(function (loginResponse) {
                if (loginResponse.authResponse) {
                    saveFacebookToken(immersiveClientId, loginResponse);
                    return;
                }
                showMessage('User cancelled login or did not fully authorize.');
            }, { scope: 'pages_manage_posts' });
        }

        // LinkedIn OAuth 2.0
        function loginWithLinkedIn() {
            const rawRedirect = window.location.origin + '/';
            const redirectUri = encodeURIComponent(rawRedirect); // Adjust as needed
            const state = Math.random().toString(36).substring(2); // Simple random state
            const scope = encodeURIComponent('openid profile w_member_social email'); // Adjust scopes as needed

            const authUrl = `https://www.linkedin.com/oauth/v2/authorization?response_type=code&client_id=${linkedInClientId}&redirect_uri=${redirectUri}&state=${state}&scope=${scope}`;
            window.location.href = authUrl;
        }

        function checkIfImmersiveClientKnown(clientId) {
            fetch(`${immersiveiApiHost}client/existence/${clientId}`)
                .then(response => {
                    if (response.ok) {
                        showMessage('Immersive account verified');

                        const accountSelect = document.getElementById("account");
                        accountSelect.value = clientId;
                        return;
                    }                    
                    showMessage(`HTTP error! Status: ${response.status}`);
                })
                .catch(error => {
                    showMessage('oops, client not known');
                });
        }

        function saveFacebookToken(clientId, loginResponse) {
            const data = {
                "ClientId": clientId,
                "LoginResponse": loginResponse
            };
            fetch(`${immersiveiApiHost}facebook/token`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (response.ok) {
                        showMessage("successfully enabled facebook");
                        return;
                    }
                    showMessage(`HTTP error! Status: ${response.status}`);
                })
                .catch(error => {
                    showMessage('Error:', error);
                });


        }

        function saveLinkedInToken(clientId, linkedInCode) {
            const data = {
                "clientId": clientId,
                "code": linkedInCode
            };
            fetch(`${immersiveiApiHost}linkedin/token`,
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })               
                .then(response => {
                    if (response.ok) {
                        showMessage("succesfully enabled linkedin");
                        return;
                    }
                    showMessage(`HTTP error! Status: ${response.status}`);
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function getLinkedInCode() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const code = urlParams.get('code');
            return code;
        }

        function getImmersiveClientId() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const clientId = urlParams.get('client');
            return clientId;
        }

        if (linkedInCode) {
            saveLinkedInToken(immersiveClientId, linkedInCode);
        }
        else if (immersiveClientId) {
            checkIfImmersiveClientKnown(immersiveClientId);

        }
        else {
            showMessage('Please select an account.')
        }

    </script>
</body>
</html>